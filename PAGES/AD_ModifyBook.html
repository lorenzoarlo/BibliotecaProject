<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8" />
    <link rel="stylesheet" href="../STYLES/main-style.css" />
    <link rel="stylesheet" href="../STYLES/PersonalArea-style.css" />
    <link rel="stylesheet" href="../STYLES/input-style.css" />
    <link rel="stylesheet" href="../STYLES/Alert-style.css" />
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Material+Icons" />
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Poppins" />
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Dancing+Script" />
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Waiting+for+the+Sunrise" />
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.13.0/css/all.min.css" />
    <link rel="icon" type="image/png" href="../MEDIA/site-icon.png"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <script src="../SCRIPTS/Utilities.js"></script>
    <script src="../SCRIPTS/Alert.js"></script>
    <script type="text/javascript">
        let alertContainer;
        const urlParams = new URLSearchParams(this.location.search);
        const OG_numeroInventario = urlParams.get('numeroInventario');

        this.onload = function() {
            alertContainer = document.querySelector(".default-container");
            resetValues_txt();
        }

        function get_book(primaryKey) {
            return new Promise(resolve => {
                const QUERY_PATH = "../PHP_QUERIES/phpFunctions-getOne.php?tableName=books"
                let toSend = new FormData();
                toSend.append("primaryKey", primaryKey);

                fetch(QUERY_PATH, { method: "POST", body: toSend })
                .then(response => response.text())
                .then(function (response) {
                    let output = JSON.parse(response);
                    if(!output["record"]) {
                        new Alert("error", "Numero inventario non corretto!", true, alertContainer);
                        document.querySelectorAll("button").forEach(button => button.disabled = true);
                    }
                    resolve(output);
                })
                .catch(error => {
                    new Alert("error", "Errore di connessione!", true, alertContainer);
                })
            });
        }

        async function resetValues_txt() {
            const OG_Record = await get_book(OG_numeroInventario);
            if(!OG_Record) return;

            let txtNumeroInventario = document.querySelector("#txtNumeroInventario");
            txtNumeroInventario.value = OG_Record["record"]["numeroInventario"];

            let txtTitolo = document.querySelector("#txtTitolo");
            txtTitolo.value = OG_Record["record"]["titolo"];

            let txtISBN = document.querySelector("#txtISBN");
            txtISBN.value = OG_Record["record"]["ISBN"];

            let txtNumeroScaffale = document.querySelector("#txtNumeroScaffale");
            txtNumeroScaffale.value = OG_Record["record"]["numeroScaffale"];

            let tableCodiceCategoria = document.querySelector("#tableCodiceCategoria");
            tableCodiceCategoria.setRecordChecked(OG_Record["record"]["codiceCategoria"]);

            let tableCodiceAutore = document.querySelector("#tableCodiceAutore");
            tableCodiceAutore.setRecordChecked(OG_Record["record"]["codiceAutore"]);
        }

        async function modifyRecord() {
            const QUERY_PATH = "../PHP_QUERIES/phpFunctions-Modify.php?tableName=books";
            const OG_Record = await get_book(OG_numeroInventario);
            if(!OG_Record) return;

            let titolo = document.querySelector("#txtTitolo").value;
            let ISBN = document.querySelector("#txtISBN").value
            let numeroScaffale = document.querySelector("#txtNumeroScaffale").value;
            let codiceCategoria = document.querySelector("#tableCodiceCategoria").getRecordChecked();
            let codiceAutore = document.querySelector("#tableCodiceAutore").getRecordChecked();

            let atLeastOneModified = (OG_Record["record"]["titolo"] == titolo) && (OG_Record["record"]["ISBN"] == ISBN) && (OG_Record["record"]["numeroScaffale"] == numeroScaffale);
            atLeastOneModified = atLeastOneModified && (OG_Record["record"]["codiceCategoria"] == codiceCategoria) && (OG_Record["record"]["codiceAutore"] == codiceAutore);

            if(atLeastOneModified) {
                new Alert("warning", "Nessun campo Ã¨ stato modificato!", true, alertContainer);
                return;
            }

            let session = Utilities.GetSession();

            let toSend = new FormData();

            toSend.append("adminUsername", session["username"]);
            toSend.append("adminPassword", session["password"]);
            toSend.append("originalPK", OG_Record["record"]["numeroInventario"]);
            if(OG_Record["record"]["titolo"] != titolo) toSend.append("titolo", titolo);
            if(OG_Record["record"]["ISBN"] != ISBN) toSend.append("ISBN", ISBN);
            if(OG_Record["record"]["numeroScaffale"] != numeroScaffale) toSend.append("numeroScaffale", numeroScaffale);
            if(OG_Record["record"]["codiceCategoria"] != codiceCategoria) toSend.append("codiceCategoria", codiceCategoria);
            if(OG_Record["record"]["codiceAutore"] != codiceAutore) toSend.append("codiceAutore", codiceAutore);

            fetch(QUERY_PATH, { method: "POST", body: toSend })
            .then(response => response.text())
            .then(function (response) {
                console.log(response);
                let output = JSON.parse(response);
                if(!output["authentication"]) {
                    new Alert("error", "Autenticazione amministratore fallita!", true, alertContainer);
                    return;
                }

                if(output["uniqueField-collision"]) {
                    new Alert("error", "Modifica fallita, collisione con campo univoco", true, alertContainer);
                    return;
                }

                if(output["updated"]) new Alert("success", "Modifica effettuata con successo", true, alertContainer);
            });
        }

        


    </script>
    <title>Biblioteca I.T.T.S.</title>
</head>
<body>
    <header class="headbar-container">
        <span class="headbar-title">I.T.T.S. O. Belluzzi - L. da Vinci</span>
        <span class="headbar-subtitle">Area personale amministratore</span>
    </header>
    <section class="default-container">
        <span class="default-title">MODIFICA LIBRO</span>
        <text-input type="text" placeholder="Numero inventario" id="txtNumeroInventario" read-only></text-input>
        <text-input type="text" placeholder="Titolo" id="txtTitolo"></text-input>
        <text-input type="text" placeholder="ISBN" id="txtISBN"></text-input>
        <!-- <text-input type="text" placeholder="Editore" id="txtEditore"></text-input> -->
        <text-input type="text" placeholder="Numero scaffale" id="txtNumeroScaffale"></text-input>
        <database-table table-name="categories"
        textbox-placeholder="Codice categoria"
        type="select"
        id="tableCodiceCategoria">
            <database-column column-coding-name="codiceCategoria" primary-key>CODICE CATEGORIA</database-column>
            <database-column column-coding-name="descrizione">DESCRIZIONE</database-column>
        </database-table>
        <database-table table-name="authors" 
        textbox-placeholder="Codice autore"
        type="select"
        id="tableCodiceAutore">
            <database-column column-coding-name="codiceAutore" primary-key>CODICE AUTORE</database-column>
            <database-column column-coding-name="nomeCompleto">NOME</database-column>
        </database-table>

        <button class="personalized-button red-button" onclick="">RIGENERA PASSWORD</button>
        <button class="personalized-button orange-button" onclick="modifyRecord()">MODIFICA CAMPI</button>
        <button class="personalized-button green-button" onclick="resetValues_txt()">RIPRISTINA AI VALORI INIZIALI</button>
    </section>
    <script src="../SCRIPTS/TextInput.js"></script>
    <script src="../SCRIPTS/DatabaseTable.js"></script>
</body>
</html>